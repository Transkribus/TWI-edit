{% extends "navi_base.html" %}
{% load i18n %}

{% load staticfiles %}

{% block content %}

<link href="{% static "css/correct.css" %}" rel="stylesheet">
<link href="{% static "css/gijgo.min.css" %}" rel="stylesheet">

<div class="top-div col-md-12">
    <div class="row">
        <h1>
            {% trans "Correction Interface, Line by Line (working title)" %}
        </h1>
	</div>
    <div class="row row-centered">
	    <div class="col-md-1">
	    	<div class="input-group input-group-sm">
	    		<span class="input-group-addon">
	    			<a class="zoom-in btn-sm" href="#"><span class="glyphicon glyphicon-zoom-in"></span></a>
	    		</span>
	    		<span class="input-group-addon">
	    			<a class="zoom-out btn-sm" href="#"><span class="glyphicon glyphicon-zoom-out"></span></a>
	    		</span>
	    	</div>
		</div>
		<div class="col-md-1">
	    	<div class="input-group input-group-sm">
				<button class="reset-image" >
					<a class="reset-image btn-sm" href="#"><span class="glyphicon glyphicon-screenshot"></span></a>
				</button>
	    	</div>
		</div>
		<div class="col-md-1">
			<div class="input-group input-group-sm">
				<span class="input-group-addon">
	    			<a class="scroll-up btn-sm" href="#"><span class="glyphicon glyphicon-arrow-up"></span></a>
	    		</span>
	    		<span class="input-group-addon">
	    			<a class="scroll-down btn-sm" href="#"><span class="glyphicon glyphicon-arrow-down"></span></a>
	    		</span>
    		</div>
		</div>
	    <div class="col-md-3">
			<div id="message"></div>
			<a href="#" class="btn btn-primary" data-target="#saveChanges">{% trans "Save changes" %}</a><br/><br/><br/>{# TODO CSS for this purpose. #}
		</div>
		<div class="col-md-2">
			<div class="input-group input-group-sm">
				<div class="btn-group btn-toggle">
			        <a class="btn btn-sm btn-primary active" data-target="#toggleView">{% trans "Profread" %}</a>
			    	<a id="toggleView_lbl" class="btn btn-sm btn-default" data-target="#toggleView">{% trans "Line by line" %}</a>
			    </div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="input-group input-group-sm">
				<span class="input-group-addon">
					<a class="first-page btn-sm" href="#"><span class="glyphicon glyphicon-step-backward"></span></a>
					<a class="previous-page btn-sm" href="#"><span class="glyphicon glyphicon-triangle-left"></span></a>
				</span>
				<input type="text" class="form-control" id="pageNumber">
				<span class="input-group-addon">
					<a class="next-page btn-sm" href="#"><span class="glyphicon glyphicon-triangle-right"></span></a>
					<a class="last-page btn-sm" href="#"><span class="glyphicon glyphicon-step-forward"></span></a>
				</span>
				<span class="input-group-addon">
					<a class="btn-sm" data-toggle="collapse" href="#thumbDiv" aria-expanded="false" aria-controls="thumbDiv"><span class="glyphicon glyphicon-th-large"></span></a>
				</span>
			</div>
		</div>
	</div>
	<div class="collapse" id="thumbDiv" style="background-color: black;">
		<div>
			<table>
				<tr id="thumbTR">
					{# The lovely JavaScript generates a thumbnail bar for navigation and inserts it here. #}
				</tr>
			</table>
		</div>
    </div>
	<div class="transcript-div">
		<div class="transcript-map-div">
			<map name="transcriptMap" id="transcriptMap">
				{% for line in lines %}
						<area line-key="{{ line|get_item:"@id"}}" id="{{ line|get_item:"@id"}}"  href="{{ line|get_item:"@id"}}"  shape="poly" >
				{% endfor %}
			</map>
			<canvas id="transcriptCanvas" style="position: absolute; z-index: 998; pointer-events: none;"></canvas>
			<img src="{{ imageUrl }}" usemap="#transcriptMap" id="transcriptImage" class="transcript-img"  style="z-index: 999;">
		</div>
	</div>
	<div class="lines-div" style="display: none;">
		<script type="text/javascript">
			function drawLineImage(lineId, coordinates) {
				var ctx = document.getElementById("canvas_" + lineId).getContext("2d");
				var image = document.getElementById("transcriptImage");
				var coords = coordinates.toString().split(',');
				var width = coords[2] - coords[0];
				var height = coords[5] - coords[1];
				ctx.drawImage(image, coords[0], coords[1], width, height, 0, 0, Math.min(width, 800), Math.min(height, 100));
				ctx.save();
			}
		</script>
		{% for line in lines %}
			<div class="input-group" style="padding-bottom: 10px;">
				<canvas id="canvas_{{ line|get_item:"@id" }}" width="800" height="100" style="border:1px solid #d3d3d3;">
					Your browser does not support the HTML5 canvas tag.
				</canvas>
				<script type="text/javascript">
				    $(function() { drawLineImage("{{ line|get_item:"@id" }}", "{{ line|get_item:"crop"|coords_for_imagemap }}") });
				</script>
				<input class="form-control" type="text" name="{{ line|get_item:"@id" }}" value="{{ line|get_item:"Unicode"}}" style="width: 800px;">
			</div>
		{% empty %}
			<p>{% trans "The page contains no lines." %}</p>
		{% endfor %}
	</div>
</div>
{% include "edit/correct_modal.html" %}
<script src="{% static "js/correct.js" %}"></script>
<script src="{% static "js/btn-toggle.js" %}"></script>
<!-- gijgo js can't be included here, it must come after everything else -->



    <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/screen.css" type="text/css"/>
    <!-- <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/theme.css" type="text/css"/>-->
    <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/theme-fixes.css" type="text/css"/>
    <link href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css" rel="stylesheet" type="text/css" />

    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>

    <!--<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js" type="text/javascript"></script>-->

    <script src="https://swisnl.github.io/jQuery-contextMenu/js/main.js" type="text/javascript"></script>

<script>
	$(function() {
		if ( "{{ view }}" == "lbl" )
			$("#toggleView_lbl").click();
	});
	var contentArray= [[0, '', [0, 0, 0, 0, 0, 0, 0, 0], 0, '']
		{% for line in lines %}
			,['{{ line|get_item:"@id"}}', '{{line|get_item:"Unicode"|default_if_none:""}}', [{{line|get_item:"crop"|coords_for_imagemap}}], {{line|get_item:"regionWidth"}}, "{{line|get_item:"@custom"}}"]
		{% endfor %}
	];
	// TODO Clean...
	var thumbArray = {{ thumbArray | safe }}; {# We assume that this is safe because each url is escape()d in the for loop in the view #}
	 {# var regionData = {{ regionData | safe }}; We don't need this yet, after all, but lets leave it here for now.  #}
	var transUnsavedChanges = "{% trans "You have unsaved changes." %}";
	var dialogBeingResized = false; {# a "semaphore" to avoid false resize events (resizing the dialog triggers such events and we only want those triggered by the window) #}
	tagItems = {
		{% for tag in tags %}"{{tag.name}}": {name: "<span href=\"#\" style=\"color: #{{tag.color}};\">{{tag.name}}</span>", type: "checkbox", isHtmlName: true} {% if not forloop.last %}, {% endif %}
		{% endfor %}
    };
	tagColors = {
		{% for tag in tags %}"{{tag.name}}": "{{tag.color}}" {% if not forloop.last %}, {% endif %}
		{% endfor %}
	}
	$("a[data-target='#saveChanges']").click(function(e) {
    	e.preventDefault();
    	$.post(window.location.href, {content: getContent(), csrfmiddlewaretoken: '{{ csrf_token }}'}, function( data ) {
    		setMessage(data);
    		changed = false;
		});
    	{# TODO Handle failures here or are we happy with the current solution? #}
	});
	$("a[data-target='#toggleView']").click(function(e) {
    	e.preventDefault();
    	$(".transcript-div").toggle();
    	$(".lines-div").toggle();
    	if ( correctModal !== undefined && correctModal.isOpen() )
			correctModal.close();

		contentArray.forEach(function(obj, i) {
			var c = document.getElementById("canvas_" + obj[0]);
			if ( c !== null && c !== undefined ) {
				var ctx = c.getContext("2d");
				ctx.canvas.width = $("#canvas_" + obj[0]).width();
				ctx.canvas.height = $("#canvas_" + obj[0]).height();
				ctx.fillStyle = "rgb(255, 255, 255)";
				ctx.fillRect(0 ,0, ctx.canvas.width, ctx.canvas.height);
				ctx.save();

				drawLineImage(obj[0], obj[2]);
			}
		});

    	{# TODO Handle failures here or are we happy with the current solution? #}
	});
	$('.transcript-map-div').draggable({
		start: function() {
			isDragged = true;
		},
		stop: function() {
			setTimeout(function() { {# A hack to avoid triggering clicks on the map if clicking a region when dragging. #}
				isDragged = false;
			}, 250);
			{# We prefer to keep it simple and let accumExtra* contain the offsets regardless of how they were created (i.e. also when the user has dragged the image): #}
			accumExtraY -= Math.round(parseInt($( ".transcript-map-div" ).css("top"), 10));
			accumExtraX -= Math.round(parseInt($( ".transcript-map-div" ).css("left"), 10));
			$(".transcript-map-div" ).css("top", "0px");
			$(".transcript-map-div" ).css("left", "0px");
			$(".transcript-map-div" ).css("transform",  "translate(" + -accumExtraX +"px, " + -accumExtraY+ "px) scale(" + (1 + zoomFactor) + ")");// Note, the CSS is set to "transform-origin: 0px 0px"
		}
	});
	$( "#transcriptMap  area" ).on('click', function(e) {
    	e.preventDefault();
		if (isDragged) {# We ignore clicks if the user has been dragging the image, we assume that that's what the user wants. #}
			return;
		//ignoreLeave = true; {# We don't want the original selection "unhighlighted" when the user moves the mouse to the modal. #}
		updateDialog($(this).attr("line-key"));
		updateCanvas();
	});
	$('area').mouseenter(function(e) {
		highlightLine(e.target.id);
	});
	$('area').mouseleave(function(e) {
		updateCanvas();
	});
	$( ".previous-page" ).on('click', function(e) {
		gotoPage(pageNo - 1);
	});
	$( ".next-page" ).on('click', function(e) {
		gotoPage(pageNo * 1 + 1);
	});
	$( ".first-page" ).on('click', function(e) {
		gotoPage(1);
	});
	$( ".last-page" ).on('click', function(e) {
		gotoPage(Number.MAX_SAFE_INTEGER);
	});
	$( ".scroll-up" ).on('click', function(e) {
		scrollToPreviousTop();
	});
	$( ".scroll-down" ).on('click', function(e) {
		scrollToNextTop();
	});
	$('#correctModal').on('keydown', function(e) {
		if (e.key.length == 1) // this is a key but if it has an accent or such, keypress won't detect it, during keyup we'll fake it if keypress doesn't handle it
			keyDownString = e.target.textContent;
	});
	$('#correctModal').on('keypress', function(e) {
		editAction(e);
		keyDownString = ''; // we detected the event and took care of it
	});
	$('#correctModal').on('keyup', function(e) {
		if ('' != keyDownString) { // process the key, if it wasn't taken care of by keypress
			// clunky way to get the special character but KeyboardEvent cautions against using the properties that seem useful for this case
			var i = 0;
			var upArray = [...e.target.textContent];
			var downArray = [...keyDownString];
			while (i < downArray.length && upArray[i] == downArray[i])
				i++;
			editAction({ // fake keypress event
				"ctrlKey": false,
				"altKey": false,
				"metaKey": false,
				"length": 1,
				"key": upArray[i],
				"preventDefault": function() {
					// no need to actually prevent the input because buildLineList() is executed anyway..
				}
			});
			keyDownString = '';
		}
		updateSelectionData();
	});
	$('#correctModal').on('mouseup', function(e) {
		updateSelectionData();
	});
	$("#correctModal").on("paste", function(e) {
		e.preventDefault();
		pasteAction(e.originalEvent.clipboardData.getData('text'));
	});
	$("#correctModal").on("drop", function(e) {
		e.preventDefault(); {# Nobody needs to do this and this breaks things. #}
	});
	$("#correctModal").on("cut", function(e) {
		eraseSelection();
	});
	$( ".typewriter-previous" ).on('click', function(e) {
		typewriterPrevious();
	});
	$( ".typewriter-next" ).on('click', function(e) {
		typewriterNext();
	});
	$( ".reset-image" ).on('click', function(e) {
		resetImage();
	});
	$( ".zoom-in" ).on('click', function(e) {
		setZoom(10);
	});
	$( ".zoom-out" ).on('click', function(e) {
		setZoom(-10);
	});
	$( ".add-line" ).on('click', function(e) {
		surroundingCount++;
		buildLineList();
	});
	$( ".enlarge-text" ).on('click', function(e) {
		resizeText(1);
	});
	$( ".shrink-text" ).on('click', function(e) {
		resizeText(-1);
	});
	$( ".remove-line" ).on('click', function(e) {
		surroundingCount--; {# TODO A function instead? #}
		if (surroundingCount >= 0)
			buildLineList();
		else
			surroundingCount = 0;
	});
	$( ".thumbs-left" ).on('click', function(e) {
		scrollThumbsLeft();
	});
	$( ".thumbs-right" ).on('click', function(e) {
		scrollThumbsRight();
	});
    $('.transcript-div').on('mousewheel DOMMouseScroll', function(e) {
    	e.preventDefault();
    	var mouseZoom;
    	if (e.originalEvent.detail > 0 || e.originalEvent.wheelDelta < 0)
			mouseZoom = -20;
		else
			mouseZoom = 20;
    	setZoom(mouseZoom, e.originalEvent.pageX - $( ".transcript-map-div" ).offset().left, e.originalEvent.pageY - $( ".transcript-map-div" ).offset().top);
    });
    $(window).resize(function() {
    	if (!dialogBeingResized) { {# If the dialog is being resized, it triggers this event and we must ignore it. #}
	    	clearTimeout(resizeTimeout); {# We don't want to respond until the window has finished resizing. #}
	    	resizeTimeout = setTimeout(function() {
				resizeContents();
	    	}, 480);
	    }
	});
	$("#pageNumber").focus(function() {
   		$(this).select();
	});
	$("#pageNumber").change(function() {
   		checkPageNumberInput();
	});
	$(function() { {# TODO Solution for people using broken computers that don't have more than one mouse button. Issues: z-index (or overflow?) and selections getting deselected... #}
        $.contextMenu({
            selector: '.tag-menu',
            build: function($trigger, e) {
            	restoreSelection(); {# TODO Request feedback. This solution has the advantage of allowing a selection to be made and the menu opened elsewhere in order not to cover the relevant text. #}
				return tagMenu();
        	},
		});
    });
    $(document.body).on("contextmenu: focus", ".context-menu-item", function(e) { // TODO Place this somewhere else....
		toggleTag($(e.target).prop("name").substr(19)); // "context-menu-input-".length is 19
	});
	$(window).on("load", function() {
		initialWidth = $('#transcriptImage').width();
		initialHeight = $('#transcriptImage').height();
		naturalWidth = $('#transcriptImage').get(0).naturalWidth;
		initialScale = initialWidth / naturalWidth;
		pathWithoutPage = "{% url 'edit:correct' collId docId %}";
		pageNo = {{pageNo}};
		var search = window.location.search + 'tco=0';// just to avoid NaN below
		thumbCountOffset = parseInt(search.substring(search.indexOf('tco=') + 4)); // "tco=".length = 4

		// If the current page isn't among the thumbs first shown, we change the offset to make it so
		thumbCountOffset = Math.max(thumbCountOffset, -pageNo + 1);
		thumbCountOffset = Math.min(thumbCountOffset, -pageNo + THUMBS_TO_SHOW);

		// Show the current page number
		checkPageNumberInput();

		updateCanvas();
		calculateAreas();
		readyToZoom = true;
		loadThumbs();

		// Getting this from the CSS file for now, set a variable instead?
		contentLineFontSize = parseInt($('.line-list').css("font-size"), 10);

		correctModal = $("#correctModal").dialog({
			autoOpen: false,
		    uiLibrary: 'bootstrap',
            resizable: true,
		    closed: function(e) {
		        setCurrentLineId(null);
				updateCanvas();
				ignoreLeave = false;
		    },
		    resize: function (e) {
				modalHeight = parseInt(this.style.height, 10);
	        	calculateLineListDimensions();
    		},
    		resizeStart: function (e) {
    			dialogBeingResized = true;
    			updateDockingStatus(false);
    		},
    		dragStart: function (e) {
    			updateDockingStatus(false);
    		},
    		resizeStop: function (e) {
    			dialogBeingResized = false;
    		}
        });
	});
</script>

<script src="{% static "js/gijgo.min.js" %}"></script>

{% endblock %}
